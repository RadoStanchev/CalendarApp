@model MeetingListViewModel
@{
    ViewData["Title"] = "Моите срещи";
    var message = TempData["MeetingMessage"] as string;
    var error = TempData["MeetingError"] as string;
    var hasMeetings = Model.UpcomingMeetings.Any() || Model.PastMeetings.Any();
    var hasSearch = !string.IsNullOrWhiteSpace(Model.SearchTerm);
}

<div class="meeting-list-page">
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3 mb-4">
        <div>
            <h1 class="h3 fw-bold mb-1">Срещи</h1>
            <p class="text-muted mb-0">Прегледайте срещите, които организирате или посещавате.</p>
        </div>
        <a class="btn btn-primary" asp-action="Create">Създай среща</a>
    </div>

    <div class="card border-0 shadow-sm mb-4">
        <div class="card-body">
            <form method="get" asp-action="My" class="d-flex flex-column flex-md-row gap-2 align-items-md-end">
                <div class="flex-grow-1">
                    <label class="form-label" for="search">Търсене по описание или място</label>
                    <input type="search" id="search" name="search" value="@Model.SearchTerm" class="form-control" placeholder="Въведете ключова дума" />
                </div>
                <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-outline-primary">Търси</button>
                    @if (hasSearch)
                    {
                        <a class="btn btn-link text-decoration-none" asp-action="My">Изчисти</a>
                    }
                </div>
            </form>
        </div>
    </div>

    @if (!string.IsNullOrWhiteSpace(message))
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <span>@message</span>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Затвори"></button>
        </div>
    }
    @if (!string.IsNullOrWhiteSpace(error))
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <span>@error</span>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Затвори"></button>
        </div>
    }

    @if (!hasMeetings)
    {
        <div class="card border-0 shadow-sm">
            <div class="card-body">
                @if (hasSearch)
                {
                    <p class="text-muted mb-0">Няма срещи, които да отговарят на вашето търсене. Опитайте с друга ключова дума.</p>
                }
                else
                {
                    <p class="text-muted mb-0">Все още не участвате в срещи. Създайте нова или изчакайте покана.</p>
                }
            </div>
        </div>
    }
    else
    {
        <div class="d-flex flex-column gap-5">
            <section class="d-flex flex-column gap-3">
                <div>
                    <h2 class="h5 fw-semibold mb-0">Предстоящи срещи</h2>
                    <p class="text-muted small mb-0">Срещи, които все още не са започнали.</p>
                </div>
                @if (Model.UpcomingMeetings.Any())
                {
                    <div class="d-flex flex-column gap-3">
                        @foreach (var meeting in Model.UpcomingMeetings)
                        {
                            @await Html.PartialAsync("_MeetingCard", meeting)
                        }
                    </div>
                }
                else
                {
                    <div class="card border-0 shadow-sm">
                        <div class="card-body">
                            <p class="text-muted mb-0">@((hasSearch ? "Няма предстоящи срещи, които да отговарят на търсенето." : "В момента нямате предстоящи срещи."))</p>
                        </div>
                    </div>
                }
            </section>

            <section class="d-flex flex-column gap-3">
                <div>
                    <h2 class="h5 fw-semibold mb-0">Минали срещи</h2>
                    <p class="text-muted small mb-0">Архив от срещите, които вече са се състояли.</p>
                </div>
                @if (Model.PastMeetings.Any())
                {
                    <div class="d-flex flex-column gap-3">
                        @foreach (var meeting in Model.PastMeetings)
                        {
                            @await Html.PartialAsync("_MeetingCard", meeting)
                        }
                    </div>
                }
                else
                {
                    <div class="card border-0 shadow-sm">
                        <div class="card-body">
                            <p class="text-muted mb-0">@((hasSearch ? "Няма минали срещи, които да отговарят на търсенето." : "Все още няма минали срещи."))</p>
                        </div>
                    </div>
                }
            </section>
        </div>
    }
</div>

@section Scripts {
    <script>
        (() => {
            const alerts = document.querySelectorAll('.meeting-list-page .alert');
            if (!alerts.length) return;
            alerts.forEach(alert => {
                const timeout = setTimeout(() => {
                    const bsAlert = bootstrap?.Alert?.getOrCreateInstance(alert);
                    bsAlert?.close();
                }, 4000);
                alert.addEventListener('close.bs.alert', () => clearTimeout(timeout));
            });
        })();
    </script>
}
